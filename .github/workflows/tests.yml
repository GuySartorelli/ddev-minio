name: tests
on:
  pull_request:
  merge_group:
  push:
    branches: [master]
    paths-ignore:
      - ".github/**/*"

  schedule:
    - cron: "25 08 * * *"

  workflow_dispatch:
    inputs:
      debug_enabled:
        type: boolean
        description: Debug with tmate
        required: false
        default: false

  # This is required for "gautamkrishnar/keepalive-workflow"
permissions:
  contents: write

defaults:
  run:
    shell: bash

env:
  # NIGHTLY_DDEV_PR_URL: "https://nightly.link/ddev/ddev/actions/runs/1720215802/ddev-linux-amd64.zip"
  # Allow ddev get to use a github token to prevent rate limiting by tests
  DDEV_GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  # Allow `--HEAD` flag when running tests against HEAD

jobs:
  test_stable:
    name: Test DDEV stable
    timeout-minutes: 5
    defaults:
      run:
        shell: bash
    runs-on: ddev
    steps:
      - uses: actions/checkout@v3

      - name: tmate debugging session
        uses: mxschmitt/action-tmate@v3
        with:
          limit-access-to-actor: true
          github-token: ${{ secrets.GITHUB_TOKEN }}
        if: github.event.inputs.debug_enabled == 'true'

      - name: tests
        run: bats tests

  # tests:
  #   defaults:
  #     run:
  #       shell: bash

  #   strategy:
  #     matrix:
  #       runner_type: [ubuntu-latest, ddev]
  #       ddev_version: [stable, HEAD]
  #     #        ddev_version: [stable, edge, HEAD, PR]
  #     fail-fast: false

  #   runs-on: ${{ matrix.runner_type }}

  #   steps:
  #     - uses: actions/checkout@v3
  #     - name: Set up Homebrew
  #       id: set-up-homebrew
  #       uses: Homebrew/actions/setup-homebrew@master
  #       if: matrix.runner_type == 'ubuntu-latest' && matrix.ddev_version == 'HEAD'

  #     - name: Environment setup
  #       if: matrix.runner_type == 'ubuntu-latest' && matrix.ddev_version == 'HEAD'
  #       run: |
  #         brew tap bats-core/bats-core
  #         brew install bats-core bats-support bats-assert mkcert
  #         mkcert -install

  #     - name: Use ddev edge
  #       if: matrix.ddev_version == 'edge'
  #       run: brew install ddev/ddev-edge/ddev

  #     - name: Use ddev HEAD
  #       if: matrix.runner_type == 'ubuntu-latest' && matrix.ddev_version == 'HEAD'
  #       run: brew install --HEAD ddev/ddev/ddev

  #     - name: Use ddev PR
  #       if: matrix.ddev_version == 'PR'
  #       run: |
  #         curl -sSL -o ddev_linux.zip ${NIGHTLY_DDEV_PR_URL}
  #         unzip ddev_linux.zip
  #         mv ddev /usr/local/bin/ddev && chmod +x /usr/local/bin/ddev

  #     - name: Download docker images
  #       if: matrix.runner_type == 'ubuntu-latest' && matrix.ddev_version == 'HEAD'
  #       run: mkdir junk && pushd junk && ddev config --auto && ddev debug download-images >/dev/null

  #     - name: tmate debugging session
  #       uses: mxschmitt/action-tmate@v3
  #       with:
  #         limit-access-to-actor: true
  #         github-token: ${{ secrets.GITHUB_TOKEN }}
  #       if: github.event.inputs.debug_enabled == 'true'

  #     - name: tests
  #       run: bats tests

  #     # keepalive-workflow adds a dummy commit if there's no other action here, keeps
  #     # GitHub from turning off tests after 60 days
  #     - uses: gautamkrishnar/keepalive-workflow@v1
  #       if: matrix.ddev_version == 'stable'
